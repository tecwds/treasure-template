#!/usr/bin/env bash

# 恢复被删除但仍被进程占用（还存在 fd）的文件

# 将第一个命令行参数保存为变量 N，通常是需要恢复的文件名
N="$1"

# 使用 lsof 查找仍被进程占用但已被删除的文件（+L1 表示只列出已删除但仍被打开的文件）
# grep 过滤出包含目标文件名 "$1" 的行
# awk 提取进程 PID（第二列）
# 构造 /proc 中对应的 fd（文件描述符）目录路径
P=/proc/$(lsof +L1 | grep "$N" | awk '{print $2}')/fd

# 列出该 fd 目录中的所有文件描述符链接
# 使用 sed 匹配包含文件名 "$N" 的行
# 正则提取文件描述符编号（如 -> /dev/fd/3 中的 3）
# xargs 对每个匹配到的描述符执行 cat 命令，从 /proc/<pid>/fd/<fd> 读取文件内容
# 最终将输出重定向到 "$N"，即恢复原文件名
ls -l $P | sed -rn "/$N/s/.* ([0-9]+) -> .*/\1/p" | xargs -I_ cat "$P/_" > "$N"